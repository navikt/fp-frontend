var v=Object.defineProperty;var y=(e,s,t)=>s in e?v(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t;var r=(e,s,t)=>y(e,typeof s!="symbol"?s+"":s,t);import{j as h}from"./jsx-runtime-QvZ8i92b.js";import{r as c}from"./index-uubelm5h.js";var T=(e=>(e.NOT_STARTED="NOT_STARTED",e.LOADING="LOADING",e.SUCCESS="SUCCESS",e.ERROR="ERROR",e))(T||{});const L={},C=c.createContext(L),w=c.createContext(void 0),x=({children:e,initialState:s})=>{const[t,a]=c.useReducer((i,o)=>{switch(o.type){case"success":return{...i,[o.key]:o.data};case"remove":return Object.keys(i).filter(n=>n!==o.key).reduce((n,l)=>({...n,[l]:i[l]}),{});default:throw new Error}},s||L);return h.jsx(C.Provider,{value:t,children:h.jsx(w.Provider,{value:a,children:e})})};x.__docgenInfo={description:`HÃ¥ndterer state for data som skal hentes fra backend kun en gang og som en trenger aksess til
mange steder i applikasjonen.`,methods:[],displayName:"RestApiProvider",props:{children:{required:!0,tsType:{name:"ReactNode"},description:""},initialState:{required:!1,tsType:{name:"signature",type:"object",raw:"{ [key in string]: any }",signature:{properties:[{key:{name:"string",required:!0},value:{name:"any"}}]}},description:""}}};const D={errors:[]},G=c.createContext(D),Q=c.createContext(void 0),q=({children:e,initialState:s})=>{const[t,a]=c.useReducer((i,o)=>{switch(o.type){case"add":return{errors:i.errors.concat(o.data)};case"remove":return D;default:throw new Error}},s||D);return h.jsx(G.Provider,{value:t,children:h.jsx(Q.Provider,{value:a,children:e})})};q.__docgenInfo={description:"Tilbyr kontekst for lagring av feilmeldinger.",methods:[],displayName:"RestApiErrorProvider",props:{children:{required:!0,tsType:{name:"ReactNode"},description:""},initialState:{required:!1,tsType:{name:"signature",type:"object",raw:"{ errors: any[] }",signature:{properties:[{key:"errors",value:{name:"Array",elements:[{name:"any"}],raw:"any[]",required:!0}}]}},description:""}}};const F=(e,s)=>!(e.length===s.length&&e.every((t,a)=>t===s[a])),H=e=>e.toLowerCase().replace(/_([a-z])/g,s=>s.toUpperCase()).replace(/_/g,""),m={updateTriggers:[],keepData:!1,suspendRequest:!1,isCachingOn:!1},S={state:T.NOT_STARTED,error:void 0,data:void 0},K=e=>function(t,a=m){const[i,o]=c.useState(S),n={...m,...a},l=c.useRef();c.useEffect(()=>{l.current=n.updateTriggers},[a.updateTriggers]);const d=l.current;return c.useEffect(()=>{if(n.suspendRequest)o(S);else{o(R=>({state:T.LOADING,error:void 0,data:n.keepData?R.data:void 0}));const u=t.filter(R=>e.hasPath(R.key.name));Promise.all(u.map(R=>e.startRequest(R.key.name,R.params,a.isCachingOn))).then(R=>{o({state:T.SUCCESS,data:R.reduce((N,P,I)=>({...N,[H(u[I].key.name)]:P.payload}),{}),error:void 0})}).catch(R=>{o({state:T.ERROR,data:void 0,error:R})})}},[...n.updateTriggers]),d&&F(d,n.updateTriggers)?{...S,data:a.keepData?i.data:void 0}:i};var E=(e=>(e.POLLING_HALTED_OR_DELAYED="POLLING_HALTED_OR_DELAYED",e.POLLING_TIMEOUT="POLLING_TIMEOUT",e.REQUEST_ERROR="REQUEST_ERROR",e.REQUEST_FINISHED="REQUEST_FINISHED",e.REQUEST_FORBIDDEN="REQUEST_FORBIDDEN",e.REQUEST_STARTED="REQUEST_STARTED",e.REQUEST_UNAUTHORIZED="REQUEST_UNAUTHORIZED",e.STATUS_REQUEST_FINISHED="STATUS_REQUEST_FINISHED",e.STATUS_REQUEST_STARTED="STATUS_REQUEST_STARTED",e.UPDATE_POLLING_MESSAGE="UPDATE_POLLING_MESSAGE",e.REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND="REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND",e))(E||{}),f=(e=>(e.PENDING="PENDING",e.COMPLETE="COMPLETE",e.DELAYED="DELAYED",e.CANCELLED="CANCELLED",e.HALTED="HALTED",e))(f||{});const b=["MANGLER_TILGANG_FEIL"],M=e=>!!e&&b.some(s=>s===e);class U extends Error{constructor(t){super("Maximum polling attempts exceeded");r(this,"location");this.location=t}}const A=e=>typeof e=="string",k=e=>{var s;return e&&((s=e.config)==null?void 0:s.responseType)==="blob"},j=e=>{const s=new FileReader;return new Promise((t,a)=>{s.onerror=()=>{s.abort(),a(new Error("Problem parsing blob"))},s.onload=()=>{s.result&&!(s.result instanceof ArrayBuffer)?t(s.result):a(new Error("Problem parsing blob"))},e instanceof Blob&&s.readAsText(e)})};class Y{constructor(s,t){r(this,"notify");r(this,"isPollingRequest");r(this,"handleError",async s=>{if(s instanceof U){this.notify(E.POLLING_TIMEOUT,{location:s.location});return}const t=this.formatError(s);if(k(s)){const a=await j(t.data);A(a)&&(t.data=JSON.parse(a))}t.isGatewayTimeoutOrNotFound?this.notify(E.REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND,{location:t.location},this.isPollingRequest):t.isUnauthorized?this.notify(E.REQUEST_UNAUTHORIZED,{message:s.message},this.isPollingRequest):t.isForbidden?this.notify(E.REQUEST_FORBIDDEN,t.data?t.data:{message:s.message}):t.is418?this.notify(E.POLLING_HALTED_OR_DELAYED,t.data):!s.response&&s.message?this.notify(E.REQUEST_ERROR,{message:s.message},this.isPollingRequest):M(t.type)||this.notify(E.REQUEST_ERROR,this.getFormattedData(t.data),this.isPollingRequest)});r(this,"getFormattedData",s=>A(s)?{message:s}:s);r(this,"findErrorData",s=>s.data?s.data:s.statusText);r(this,"formatError",s=>{const t=s&&s.response?s.response:void 0;return{data:t?this.findErrorData(t):void 0,type:t&&t.data?t.data.type:void 0,status:t?t.status:void 0,isForbidden:t?t.status===403:void 0,isUnauthorized:t?t.status===401:void 0,is418:t?t.status===418:void 0,isGatewayTimeoutOrNotFound:t?t.status===504||t.status===404:void 0,location:t&&t.config?t.config.url:void 0}});this.notify=s,this.isPollingRequest=t}}const B=202,$=50,p="INTERNAL_CANCELLATION",z=e=>new Promise(s=>{setTimeout(s,e)}),W=e=>!!(e!=null&&e.location)&&(e.status===f.DELAYED||e.status===f.HALTED);class V{constructor(s,t,a,i){r(this,"httpClientApi");r(this,"restMethod");r(this,"path");r(this,"config");r(this,"maxPollingLimit",$);r(this,"notify",()=>{});r(this,"isCancelled",!1);r(this,"isPollingRequest",!1);r(this,"setNotificationEmitter",s=>{this.notify=s});r(this,"execLongPolling",async(s,t=0,a=0)=>{if(a===this.maxPollingLimit)throw this.notify(E.REQUEST_FINISHED),new U(s||"No location");const i=a<30?t:t+(a-30)*t;if(await z(i),!s||this.isCancelled)return null;this.notify(E.STATUS_REQUEST_STARTED);const o=await this.httpClientApi.get(s);if(this.notify(E.STATUS_REQUEST_FINISHED),!("data"in o))return o;const n=o.data;if(n&&n.status===f.PENDING){const{pollIntervalMillis:l,message:d}=n;return this.notify(E.UPDATE_POLLING_MESSAGE,d),this.execLongPolling(s,l,a+1)}return o});r(this,"execute",async(s,t,a)=>{let i=await t(s,a);if("status"in i&&i.status===B){this.isPollingRequest=!0;try{return await this.execLongPolling(i.headers.location)}catch(o){const n=o.response?o.response.data:void 0;if(W(n))i=await this.httpClientApi.get(n.location),"data"in i&&this.notify(E.POLLING_HALTED_OR_DELAYED,i.data.taskStatus);else throw o}}return i});r(this,"cancel",()=>{this.isCancelled=!0});r(this,"start",async s=>{this.notify(E.REQUEST_STARTED);try{const t=await this.execute(this.path,this.restMethod,s);if(this.isCancelled)throw new Error(p);const a=t!==null&&"data"in t?t.data:void 0;return this.notify(E.REQUEST_FINISHED,a,this.isPollingRequest),a?{payload:a}:{payload:void 0}}catch(t){const{response:a}=t;if(a&&a.status===401&&a.headers&&a.headers.location){const i=encodeURIComponent(window.location.pathname+window.location.search);window.location.href=`${a.headers.location}?redirectTo=${i}`}throw(t==null?void 0:t.message)!==p&&new Y(this.notify,this.isPollingRequest).handleError(t),t}});this.httpClientApi=s,this.restMethod=t,this.path=a,this.config=i,this.maxPollingLimit=i.maxPollingLimit||this.maxPollingLimit}}const O={updateTriggers:[],keepData:!1,suspendRequest:!1,isCachingOn:!1},_={state:T.NOT_STARTED,error:void 0,data:void 0},tt=e=>function(t,a,i=O){const o={...O,...i},[n,l]=c.useState(_);return c.useEffect(()=>{e.hasPath(t.name)&&!o.suspendRequest?(l(d=>({state:T.LOADING,error:void 0,data:o.keepData?d.data:void 0})),e.startRequest(t.name,a,i.isCachingOn).then(d=>{l({state:T.SUCCESS,data:d.payload,error:void 0})}).catch(d=>{(d==null?void 0:d.message)!==p&&l({state:T.ERROR,data:void 0,error:d})})):e.hasPath(t.name)||l(_)},[...o.updateTriggers]),!e.hasPath(t.name)&&o.suspendRequest?_:n},g={state:T.NOT_STARTED,error:void 0,data:void 0},et=e=>function(t){const[a,i]=c.useState(g),o=c.useCallback((l,d=!1)=>e.hasPath(t.name)?(i(u=>({state:T.LOADING,data:d?u.data:void 0,error:void 0})),e.startRequest(t.name,l).then(u=>(i({state:T.SUCCESS,data:u.payload,error:void 0}),Promise.resolve(u.payload))).catch(u=>{if((u==null?void 0:u.message)!==p)throw i({state:T.ERROR,data:void 0,error:u}),u})):(i(g),Promise.resolve(void 0)),[]),n=c.useCallback(()=>{i(g)},[]);return{startRequest:o,resetRequestData:n,...a}};export{E,T as R,w as a,x as b,q as c,Q as d,C as e,V as f,tt as g,K as h,et as i};
