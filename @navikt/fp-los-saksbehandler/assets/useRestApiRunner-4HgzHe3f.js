var v=Object.defineProperty;var y=(t,e,s)=>e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var o=(t,e,s)=>y(t,typeof e!="symbol"?e+"":e,s);import{j as h}from"./jsx-runtime-QvZ8i92b.js";import{r as c}from"./index-uubelm5h.js";var T=(t=>(t.NOT_STARTED="NOT_STARTED",t.LOADING="LOADING",t.SUCCESS="SUCCESS",t.ERROR="ERROR",t))(T||{});const N={},C=c.createContext(N),G=c.createContext(void 0),w=({children:t,initialState:e})=>{const[s,a]=c.useReducer((i,n)=>{switch(n.type){case"success":return{...i,[n.key]:n.data};case"remove":return Object.keys(i).filter(r=>r!==n.key).reduce((r,l)=>({...r,[l]:i[l]}),{});default:throw new Error}},e||N);return h.jsx(C.Provider,{value:s,children:h.jsx(G.Provider,{value:a,children:t})})};w.__docgenInfo={description:`HÃ¥ndterer state for data som skal hentes fra backend kun en gang og som en trenger aksess til
mange steder i applikasjonen.`,methods:[],displayName:"RestApiProvider",props:{children:{required:!0,tsType:{name:"ReactNode"},description:""},initialState:{required:!1,tsType:{name:"signature",type:"object",raw:"{ [key in string]: any }",signature:{properties:[{key:{name:"string",required:!0},value:{name:"any"}}]}},description:""}}};const D={errors:[]},F=c.createContext(D),x=c.createContext(void 0),Q=({children:t,initialState:e})=>{const[s,a]=c.useReducer((i,n)=>{switch(n.type){case"add":return{errors:i.errors.concat(n.data)};case"remove":return D;default:throw new Error}},e||D);return h.jsx(F.Provider,{value:s,children:h.jsx(x.Provider,{value:a,children:t})})};Q.__docgenInfo={description:"Tilbyr kontekst for lagring av feilmeldinger.",methods:[],displayName:"RestApiErrorProvider",props:{children:{required:!0,tsType:{name:"ReactNode"},description:""},initialState:{required:!1,tsType:{name:"signature",type:"object",raw:"{ errors: any[] }",signature:{properties:[{key:"errors",value:{name:"Array",elements:[{name:"any"}],raw:"any[]",required:!0}}]}},description:""}}};const M=(t,e)=>!(t.length===e.length&&t.every((s,a)=>s===e[a])),q=t=>t.toLowerCase().replace(/_([a-z])/g,e=>e.toUpperCase()).replace(/_/g,""),A={updateTriggers:[],keepData:!1,suspendRequest:!1,isCachingOn:!1},p={state:T.NOT_STARTED,error:void 0,data:void 0},tt=t=>function(s,a=A){const[i,n]=c.useState(p),r={...A,...a},l=c.useRef();c.useEffect(()=>{l.current=r.updateTriggers},[a.updateTriggers]);const E=l.current;return c.useEffect(()=>{if(r.suspendRequest)n(p);else{n(R=>({state:T.LOADING,error:void 0,data:r.keepData?R.data:void 0}));const u=s.filter(R=>t.hasPath(R.key.name));Promise.all(u.map(R=>t.startRequest(R.key.name,R.params,a.isCachingOn))).then(R=>{n({state:T.SUCCESS,data:R.reduce((U,I,P)=>({...U,[q(u[P].key.name)]:I.payload}),{}),error:void 0})}).catch(R=>{n({state:T.ERROR,data:void 0,error:R})})}},[...r.updateTriggers]),E&&M(E,r.updateTriggers)?{...p,data:a.keepData?i.data:void 0}:i};var d=(t=>(t.POLLING_HALTED_OR_DELAYED="POLLING_HALTED_OR_DELAYED",t.POLLING_TIMEOUT="POLLING_TIMEOUT",t.REQUEST_ERROR="REQUEST_ERROR",t.REQUEST_FINISHED="REQUEST_FINISHED",t.REQUEST_FORBIDDEN="REQUEST_FORBIDDEN",t.REQUEST_STARTED="REQUEST_STARTED",t.REQUEST_UNAUTHORIZED="REQUEST_UNAUTHORIZED",t.STATUS_REQUEST_FINISHED="STATUS_REQUEST_FINISHED",t.STATUS_REQUEST_STARTED="STATUS_REQUEST_STARTED",t.UPDATE_POLLING_MESSAGE="UPDATE_POLLING_MESSAGE",t.REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND="REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND",t))(d||{}),f=(t=>(t.PENDING="PENDING",t.COMPLETE="COMPLETE",t.DELAYED="DELAYED",t.CANCELLED="CANCELLED",t.HALTED="HALTED",t))(f||{}),H=(t=>(t.MANGLER_TILGANG_FEIL="MANGLER_TILGANG_FEIL",t.TOMT_RESULTAT_FEIL="TOMT_RESULTAT_FEIL",t.BEHANDLING_ENDRET_FEIL="BEHANDLING_ENDRET_FEIL",t.GENERELL_FEIL="GENERELL_FEIL",t))(H||{});const b=["MANGLER_TILGANG_FEIL"],k=t=>{var e;return((e=t==null?void 0:t.response)==null?void 0:e.data)??t},et=(t,e)=>!!e&&k(e).type===t,j=t=>!!t&&b.some(e=>e===t);class O extends Error{constructor(s){super("Maximum polling attempts exceeded");o(this,"location");this.location=s}}const g=t=>typeof t=="string",Y=t=>{var e;return t&&((e=t.config)==null?void 0:e.responseType)==="blob"},B=t=>{const e=new FileReader;return new Promise((s,a)=>{e.onerror=()=>{e.abort(),a(new Error("Problem parsing blob"))},e.onload=()=>{e.result&&!(e.result instanceof ArrayBuffer)?s(e.result):a(new Error("Problem parsing blob"))},t instanceof Blob&&e.readAsText(t)})};class ${constructor(e,s){o(this,"notify");o(this,"isPollingRequest");o(this,"handleError",async e=>{if(e instanceof O){this.notify(d.POLLING_TIMEOUT,{location:e.location});return}const s=this.formatError(e);if(Y(e)){const a=await B(s.data);g(a)&&(s.data=JSON.parse(a))}s.isGatewayTimeoutOrNotFound?this.notify(d.REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND,{location:s.location},this.isPollingRequest):s.isUnauthorized?this.notify(d.REQUEST_UNAUTHORIZED,{message:e.message},this.isPollingRequest):s.isForbidden?this.notify(d.REQUEST_FORBIDDEN,s.data?s.data:{message:e.message}):s.is418?this.notify(d.POLLING_HALTED_OR_DELAYED,s.data):!e.response&&e.message?this.notify(d.REQUEST_ERROR,{message:e.message},this.isPollingRequest):j(s.type)||this.notify(d.REQUEST_ERROR,this.getFormattedData(s.data),this.isPollingRequest)});o(this,"getFormattedData",e=>g(e)?{message:e}:e);o(this,"findErrorData",e=>e.data?e.data:e.statusText);o(this,"formatError",e=>{const s=e&&e.response?e.response:void 0;return{data:s?this.findErrorData(s):void 0,type:s&&s.data?s.data.type:void 0,status:s?s.status:void 0,isForbidden:s?s.status===403:void 0,isUnauthorized:s?s.status===401:void 0,is418:s?s.status===418:void 0,isGatewayTimeoutOrNotFound:s?s.status===504||s.status===404:void 0,location:s&&s.config?s.config.url:void 0}});this.notify=e,this.isPollingRequest=s}}const z=202,W=50,_="INTERNAL_CANCELLATION",Z=t=>new Promise(e=>{setTimeout(e,t)}),J=t=>!!(t!=null&&t.location)&&(t.status===f.DELAYED||t.status===f.HALTED);class st{constructor(e,s,a,i){o(this,"httpClientApi");o(this,"restMethod");o(this,"path");o(this,"config");o(this,"maxPollingLimit",W);o(this,"notify",()=>{});o(this,"isCancelled",!1);o(this,"isPollingRequest",!1);o(this,"setNotificationEmitter",e=>{this.notify=e});o(this,"execLongPolling",async(e,s=0,a=0)=>{if(a===this.maxPollingLimit)throw this.notify(d.REQUEST_FINISHED),new O(e||"No location");const i=a<30?s:s+(a-30)*s;if(await Z(i),!e||this.isCancelled)return null;this.notify(d.STATUS_REQUEST_STARTED);const n=await this.httpClientApi.get(e);if(this.notify(d.STATUS_REQUEST_FINISHED),!("data"in n))return n;const r=n.data;if(r&&r.status===f.PENDING){const{pollIntervalMillis:l,message:E}=r;return this.notify(d.UPDATE_POLLING_MESSAGE,E),this.execLongPolling(e,l,a+1)}return n});o(this,"execute",async(e,s,a)=>{let i=await s(e,a);if("status"in i&&i.status===z){this.isPollingRequest=!0;try{return await this.execLongPolling(i.headers.location)}catch(n){const r=n.response?n.response.data:void 0;if(J(r))i=await this.httpClientApi.get(r.location),"data"in i&&this.notify(d.POLLING_HALTED_OR_DELAYED,i.data.taskStatus);else throw n}}return i});o(this,"cancel",()=>{this.isCancelled=!0});o(this,"start",async e=>{this.notify(d.REQUEST_STARTED);try{const s=await this.execute(this.path,this.restMethod,e);if(this.isCancelled)throw new Error(_);const a=s!==null&&"data"in s?s.data:void 0;return this.notify(d.REQUEST_FINISHED,a,this.isPollingRequest),a?{payload:a}:{payload:void 0}}catch(s){const{response:a}=s;if(a&&a.status===401&&a.headers&&a.headers.location){const i=encodeURIComponent(window.location.pathname+window.location.search);window.location.href=`${a.headers.location}?redirectTo=${i}`}throw(s==null?void 0:s.message)!==_&&new $(this.notify,this.isPollingRequest).handleError(s),s}});this.httpClientApi=e,this.restMethod=s,this.path=a,this.config=i,this.maxPollingLimit=i.maxPollingLimit||this.maxPollingLimit}}const m={updateTriggers:[],keepData:!1,suspendRequest:!1,isCachingOn:!1},L={state:T.NOT_STARTED,error:void 0,data:void 0},at=t=>function(s,a,i=m){const n={...m,...i},[r,l]=c.useState(L);return c.useEffect(()=>{t.hasPath(s.name)&&!n.suspendRequest?(l(E=>({state:T.LOADING,error:void 0,data:n.keepData?E.data:void 0})),t.startRequest(s.name,a,i.isCachingOn).then(E=>{l({state:T.SUCCESS,data:E.payload,error:void 0})}).catch(E=>{(E==null?void 0:E.message)!==_&&l({state:T.ERROR,data:void 0,error:E})})):t.hasPath(s.name)||l(L)},[...n.updateTriggers]),!t.hasPath(s.name)&&n.suspendRequest?L:r},S={state:T.NOT_STARTED,error:void 0,data:void 0},it=t=>function(s){const[a,i]=c.useState(S),n=c.useCallback((l,E=!1)=>t.hasPath(s.name)?(i(u=>({state:T.LOADING,data:E?u.data:void 0,error:void 0})),t.startRequest(s.name,l).then(u=>(i({state:T.SUCCESS,data:u.payload,error:void 0}),Promise.resolve(u.payload))).catch(u=>{if((u==null?void 0:u.message)!==_)throw i({state:T.ERROR,data:void 0,error:u}),u})):(i(S),Promise.resolve(void 0)),[]),r=c.useCallback(()=>{i(S)},[]);return{startRequest:n,resetRequestData:r,...a}};export{H as E,x as R,O as T,T as a,G as b,C as c,d,et as e,st as f,k as g,at as h,tt as i,it as j,w as k,Q as l};
