var y=Object.defineProperty;var C=(t,s,e)=>s in t?y(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var r=(t,s,e)=>C(t,typeof s!="symbol"?s+"":s,e);import{j as R}from"./jsx-runtime-CLpGMVip.js";import{r as E}from"./index-B5OHeJSP.js";var f=(t=>(t.NOT_STARTED="NOT_STARTED",t.LOADING="LOADING",t.SUCCESS="SUCCESS",t.ERROR="ERROR",t))(f||{});const L={},w=E.createContext(L),x=E.createContext(void 0),G=({children:t,initialState:s})=>{const[e,a]=E.useReducer((n,i)=>{switch(i.type){case"success":return{...n,[i.key]:i.data};case"remove":return Object.keys(n).filter(o=>o!==i.key).reduce((o,c)=>({...o,[c]:n[c]}),{});default:throw new Error}},s||L);return R.jsx(w.Provider,{value:e,children:R.jsx(x.Provider,{value:a,children:t})})};G.__docgenInfo={description:`HÃ¥ndterer state for data som skal hentes fra backend kun en gang og som en trenger aksess til
mange steder i applikasjonen.`,methods:[],displayName:"RestApiProvider",props:{children:{required:!0,tsType:{name:"ReactNode"},description:""},initialState:{required:!1,tsType:{name:"signature",type:"object",raw:"{ [key in string]: any }",signature:{properties:[{key:{name:"string",required:!0},value:{name:"any"}}]}},description:""}}};const D={errors:[]},Q=E.createContext(D),q=E.createContext(void 0),F=({children:t,initialState:s})=>{const[e,a]=E.useReducer((n,i)=>{switch(i.type){case"add":return{errors:n.errors.concat(i.data)};case"remove":return D;default:throw new Error}},s||D);return R.jsx(Q.Provider,{value:e,children:R.jsx(q.Provider,{value:a,children:t})})};F.__docgenInfo={description:"Tilbyr kontekst for lagring av feilmeldinger.",methods:[],displayName:"RestApiErrorProvider",props:{children:{required:!0,tsType:{name:"ReactNode"},description:""},initialState:{required:!1,tsType:{name:"signature",type:"object",raw:"{ errors: any[] }",signature:{properties:[{key:"errors",value:{name:"Array",elements:[{name:"any"}],raw:"any[]",required:!0}}]}},description:""}}};const H=(t,s)=>!(t.length===s.length&&t.every((e,a)=>e===s[a])),b=t=>t.toLowerCase().replace(/_([a-z])/g,s=>s.toUpperCase()).replace(/_/g,""),m={updateTriggers:[],keepData:!1,suspendRequest:!1,isCachingOn:!1},S={state:f.NOT_STARTED,error:void 0,data:void 0},K=t=>function(e,a=m){const[n,i]=E.useState(S),o={...m,...a},c=E.useRef(null);E.useEffect(()=>{c.current=o.updateTriggers},[a.updateTriggers]);const d=c.current;return E.useEffect(()=>{if(o.suspendRequest)i(S);else{i(T=>({state:f.LOADING,error:void 0,data:o.keepData?T.data:void 0}));const l=e.filter(T=>t.hasPath(T.key.name));Promise.all(l.map(T=>t.startRequest(T.key.name,T.params,a.isCachingOn))).then(T=>{i({state:f.SUCCESS,data:T.reduce((N,P,I)=>({...N,[b(l[I].key.name)]:P.payload}),{}),error:void 0})}).catch(T=>{i({state:f.ERROR,data:void 0,error:T})})}},[...o.updateTriggers]),d&&H(d,o.updateTriggers)?{...S,data:a.keepData?n.data:void 0}:n};var u=(t=>(t.POLLING_HALTED_OR_DELAYED="POLLING_HALTED_OR_DELAYED",t.POLLING_TIMEOUT="POLLING_TIMEOUT",t.REQUEST_ERROR="REQUEST_ERROR",t.REQUEST_FINISHED="REQUEST_FINISHED",t.REQUEST_FORBIDDEN="REQUEST_FORBIDDEN",t.REQUEST_STARTED="REQUEST_STARTED",t.REQUEST_UNAUTHORIZED="REQUEST_UNAUTHORIZED",t.STATUS_REQUEST_FINISHED="STATUS_REQUEST_FINISHED",t.STATUS_REQUEST_STARTED="STATUS_REQUEST_STARTED",t.UPDATE_POLLING_MESSAGE="UPDATE_POLLING_MESSAGE",t.REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND="REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND",t))(u||{}),h=(t=>(t.PENDING="PENDING",t.COMPLETE="COMPLETE",t.DELAYED="DELAYED",t.CANCELLED="CANCELLED",t.HALTED="HALTED",t))(h||{});const M=["MANGLER_TILGANG_FEIL"],k=t=>!!t&&M.some(s=>s===t);class U extends Error{constructor(e){super("Maximum polling attempts exceeded");r(this,"location");this.location=e}}const A=t=>typeof t=="string",v=t=>{var s;return t&&((s=t.config)==null?void 0:s.responseType)==="blob"},j=t=>{const s=new FileReader;return new Promise((e,a)=>{s.onerror=()=>{s.abort(),a(new Error("Problem parsing blob"))},s.onload=()=>{s.result&&!(s.result instanceof ArrayBuffer)?e(s.result):a(new Error("Problem parsing blob"))},t instanceof Blob&&s.readAsText(t)})};class Y{constructor(s,e){r(this,"notify");r(this,"isPollingRequest");r(this,"handleError",async s=>{if(s instanceof U){this.notify(u.POLLING_TIMEOUT,{location:s.location});return}const e=this.formatError(s);if(v(s)){const a=await j(e.data);A(a)&&(e.data=JSON.parse(a))}e.isGatewayTimeoutOrNotFound?this.notify(u.REQUEST_GATEWAY_TIMEOUT_OR_NOT_FOUND,{location:e.location},this.isPollingRequest):e.isUnauthorized?this.notify(u.REQUEST_UNAUTHORIZED,{message:s.message},this.isPollingRequest):e.isForbidden?this.notify(u.REQUEST_FORBIDDEN,e.data?e.data:{message:s.message}):e.is418?this.notify(u.POLLING_HALTED_OR_DELAYED,e.data):!s.response&&s.message?this.notify(u.REQUEST_ERROR,{message:s.message},this.isPollingRequest):k(e.type)||this.notify(u.REQUEST_ERROR,this.getFormattedData(e.data),this.isPollingRequest)});r(this,"getFormattedData",s=>A(s)?{message:s}:s);r(this,"findErrorData",s=>s.data?s.data:s.statusText);r(this,"formatError",s=>{const e=s&&s.response?s.response:void 0;return{data:e?this.findErrorData(e):void 0,type:e&&e.data?e.data.type:void 0,status:e?e.status:void 0,isForbidden:e?e.status===403:void 0,isUnauthorized:e?e.status===401:void 0,is418:e?e.status===418:void 0,isGatewayTimeoutOrNotFound:e?e.status===504||e.status===404:void 0,location:e&&e.config?e.config.url:void 0}});this.notify=s,this.isPollingRequest=e}}const B=202,$=50,p="INTERNAL_CANCELLATION",z=t=>new Promise(s=>{setTimeout(s,t)}),W=t=>!!(t!=null&&t.location)&&(t.status===h.DELAYED||t.status===h.HALTED);class V{constructor(s,e,a,n){r(this,"httpClientApi");r(this,"restMethod");r(this,"path");r(this,"config");r(this,"maxPollingLimit",$);r(this,"notify",()=>{});r(this,"isCancelled",!1);r(this,"isPollingRequest",!1);r(this,"setNotificationEmitter",s=>{this.notify=s});r(this,"execLongPolling",async(s,e=0,a=0)=>{if(a===this.maxPollingLimit)throw this.notify(u.REQUEST_FINISHED),new U(s||"No location");const n=a<30?e:e+(a-30)*e;if(await z(n),!s||this.isCancelled)return null;this.notify(u.STATUS_REQUEST_STARTED);const i=await this.httpClientApi.get(s);if(this.notify(u.STATUS_REQUEST_FINISHED),!("data"in i))return i;const o=i.data;if(o&&o.status===h.PENDING){const{pollIntervalMillis:c,message:d}=o;return this.notify(u.UPDATE_POLLING_MESSAGE,d),this.execLongPolling(s,c,a+1)}return i});r(this,"execute",async(s,e,a)=>{let n=await e(s,a);if("status"in n&&n.status===B){this.isPollingRequest=!0;try{return await this.execLongPolling(n.headers.location)}catch(i){const o=i.response?i.response.data:void 0;if(W(o))n=await this.httpClientApi.get(o.location),"data"in n&&this.notify(u.POLLING_HALTED_OR_DELAYED,n.data.taskStatus);else throw i}}return n});r(this,"cancel",()=>{this.isCancelled=!0});r(this,"start",async s=>{this.notify(u.REQUEST_STARTED);try{const e=await this.execute(this.path,this.restMethod,s);if(this.isCancelled)throw new Error(p);const a=e!==null&&"data"in e?e.data:void 0;return this.notify(u.REQUEST_FINISHED,a,this.isPollingRequest),a?{payload:a}:{payload:void 0}}catch(e){const{response:a}=e;if(a&&a.status===401&&a.headers&&a.headers.location){const n=encodeURIComponent(window.location.pathname+window.location.search);window.location.href=`${a.headers.location}?redirectTo=${n}`}throw(e==null?void 0:e.message)!==p&&new Y(this.notify,this.isPollingRequest).handleError(e),e}});this.httpClientApi=s,this.restMethod=e,this.path=a,this.config=n,this.maxPollingLimit=n.maxPollingLimit||this.maxPollingLimit}}const O={updateTriggers:[],keepData:!1,suspendRequest:!1,isCachingOn:!1},_={state:f.NOT_STARTED,error:void 0,data:void 0},ee=t=>function(e,a,n=O){const i={...O,...n},[o,c]=E.useState(_);return E.useEffect(()=>{t.hasPath(e.name)&&!i.suspendRequest?(c(d=>({state:f.LOADING,error:void 0,data:i.keepData?d.data:void 0})),t.startRequest(e.name,a,n.isCachingOn).then(d=>{c({state:f.SUCCESS,data:d.payload,error:void 0})}).catch(d=>{(d==null?void 0:d.message)!==p&&c({state:f.ERROR,data:void 0,error:d})})):t.hasPath(e.name)||c(_)},[...i.updateTriggers]),!t.hasPath(e.name)&&i.suspendRequest?_:o},g={state:f.NOT_STARTED,error:void 0,data:void 0},te=t=>function(e){const[a,n]=E.useState(g),i=E.useCallback((c,d=!1)=>t.hasPath(e.name)?(n(l=>({state:f.LOADING,data:d?l.data:void 0,error:void 0})),t.startRequest(e.name,c).then(l=>(n({state:f.SUCCESS,data:l.payload,error:void 0}),Promise.resolve(l.payload))).catch(l=>{if((l==null?void 0:l.message)!==p)throw n({state:f.ERROR,data:void 0,error:l}),l})):(n(g),Promise.resolve(void 0)),[]),o=E.useCallback(()=>{n(g)},[]);return{startRequest:i,resetRequestData:o,...a}};export{h as A,u as E,q as R,f as a,G as b,F as c,Q as d,x as e,w as f,V as g,ee as h,K as i,te as j};
